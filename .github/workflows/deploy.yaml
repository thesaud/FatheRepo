name: Deploy TeaResh to IIS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    env:
      SITE_NAME: TeaResh
      APP_POOL: TeaResh-AppPool
      SITE_PORT: 8080
      TARGET_PATH: C:\inetpub\wwwroot\TeaResh
      ZIP_PATH: C:\inetpub\wwwroot\TeaResh.zip

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: 8.0.x

      - name: Restore dependencies
        run: dotnet restore TeaResh\TeaResh.csproj

      - name: Build project
        run: dotnet build TeaResh\TeaResh.csproj --configuration Release

      - name: Publish project
        run: dotnet publish TeaResh\TeaResh.csproj --configuration Release --output ${{ env.TARGET_PATH }}\publish

      - name: Zip published files
        run: |
          if (Test-Path ${{ env.ZIP_PATH }}) { Remove-Item ${{ env.ZIP_PATH }} -Force }
          Compress-Archive -Path "${{ env.TARGET_PATH }}\publish\*" -DestinationPath ${{ env.ZIP_PATH }} -Force

      - name: Deploy to IIS using appcmd
        run: |
          # Stop App Pool if exists
          $appPoolExists = & $env:windir\system32\inetsrv\appcmd list apppool ${{ env.APP_POOL }} 2>$null
          if ($appPoolExists) {
            & $env:windir\system32\inetsrv\appcmd stop apppool /apppool.name:${{ env.APP_POOL }} | Out-Null
          }

          # Clear target folder
          if (Test-Path ${{ env.TARGET_PATH }}) {
            Remove-Item "${{ env.TARGET_PATH }}\*" -Recurse -Force
          } else {
            New-Item -Path ${{ env.TARGET_PATH }} -ItemType Directory | Out-Null
          }

          # Extract zip to target folder
          Expand-Archive -Path ${{ env.ZIP_PATH }} -DestinationPath ${{ env.TARGET_PATH }} -Force

          # Flatten if single inner folder
          $innerDirs = Get-ChildItem ${{ env.TARGET_PATH }} -Directory
          if ($innerDirs.Count -eq 1) {
            Move-Item "$($innerDirs[0].FullName)\*" ${{ env.TARGET_PATH }} -Force
            Remove-Item $innerDirs[0].FullName -Recurse -Force
          }

          # Create App Pool if not exists
          if (-not $appPoolExists) {
            & $env:windir\system32\inetsrv\appcmd add apppool /name:${{ env.APP_POOL }} /managedPipelineMode:Integrated /managedRuntimeVersion:
          }

          # Create Site if not exists
          $siteExists = & $env:windir\system32\inetsrv\appcmd list site ${{ env.SITE_NAME }} 2>$null
          if (-not $siteExists) {
            & $env:windir\system32\inetsrv\appcmd add site /name:${{ env.SITE_NAME }} /physicalPath:${{ env.TARGET_PATH }} /bindings:http/*:${{ env.SITE_PORT }}:
            & $env:windir\system32\inetsrv\appcmd set site ${{ env.SITE_NAME }} /applicationDefaults.applicationPool:${{ env.APP_POOL }}
          }

          # Start App Pool
          & $env:windir\system32\inetsrv\appcmd start apppool /apppool.name:${{ env.APP_POOL }} | Out-Null

          Write-Host "âœ… Deployment completed successfully!"
